<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8"/>
  <title th:text="'あなたのMBTIは ' + ${personality.name} + ' です'">診断結果</title>
  <link rel="stylesheet" th:href="@{/css/styles.css}"/>

  <!-- Chart.js 本体 -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <!-- datalabels プラグイン -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
</head>
<body th:class="${resultType}">
  <div class="result-container">
    <h1 class="result-title"
        th:text="'あなたのMBTIは『' + ${personality.name} + '』（' + ${resultType} + '）です'">
      あなたのMBTIは『運動家』（ENFP）です
    </h1>

    <img th:src="@{/mbti/images/{img}(img=${personality.imageName})}"
         th:alt="${personality.name}"
         class="result-image"/>

    <canvas id="mbtiChart" width="700" height="300"></canvas>

    <!-- グローバル JS 変数定義（必ず result-chart.js の前） -->
    <script th:inline="javascript">
      /*<![CDATA[*/
      // ラベル
      var mbtiLabels = ['E vs I','S vs N','T vs F','J vs P'];
      // データ（大きい方・小さい方）
      var mbtiMax = [
        Math.max([[${chartData.overallEPercent}]], [[${chartData.overallIPercent}]]),
        Math.max([[${chartData.overallSPercent}]], [[${chartData.overallNPercent}]]),
        Math.max([[${chartData.overallTPercent}]], [[${chartData.overallFPercent}]]),
        Math.max([[${chartData.overallJPercent}]], [[${chartData.overallPPercent}]])
      ];
      var mbtiMin = [
        Math.min([[${chartData.overallEPercent}]], [[${chartData.overallIPercent}]]),
        Math.min([[${chartData.overallSPercent}]], [[${chartData.overallNPercent}]]),
        Math.min([[${chartData.overallTPercent}]], [[${chartData.overallFPercent}]]),
        Math.min([[${chartData.overallJPercent}]], [[${chartData.overallPPercent}]])
      ];
      // タイプ別カラー
      var colorMap = {
        'INTJ':'#d1c4e9','INTP':'#d1c4e9','ENTJ':'#d1c4e9','ENTP':'#d1c4e9',
        'ISTJ':'#b3e5fc','ISFJ':'#b3e5fc','ESTJ':'#b3e5fc','ESFJ':'#b3e5fc',
        'INFJ':'#dcedc8','INFP':'#dcedc8','ENFJ':'#dcedc8','ENFP':'#dcedc8',
        'ISTP':'#fff9c4','ISFP':'#fff9c4','ESTP':'#fff9c4','ESFP':'#fff9c4'
      };
      var barColor = colorMap['[[${resultType}]]'];
      /*]]>*/
    </script>

    <!-- 描画スクリプト -->
    <script th:src="@{/js/result-chart.js}"></script>

    <div class="description" th:text="${personality.description}">
      ENFP は好奇心旺盛で社交的。…
    </div>
    <div class="restart">
      <a th:href="@{/start}">
        <button class="start-button">もう一度診断する</button>
      </a>
    </div>
  </div>
</body>
</html>